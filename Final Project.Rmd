---
title: "Final Project"
author: "Nathan Holterhoff, Taylor Kelly, Anthony Liu"
date: "`r Sys.Date()`"
output: html_document

---


We are choosing Washington since it is the most underserved state from the IAC on the West Coast but still has enough data that observations can be me made.

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
#install.packages("tidyverse")
# install.packages("scales")
library(scales)
library(readxl)
library(dplyr)
library(ggplot2)
library(stringr)
library(maps)

```

```{r}
file_path <- 'IAC_Database_20240514.xlsx'
sheet_names <- excel_sheets(file_path)

naics_codes <-  read_excel("2-6 digit_2022_Codes.xlsx")

arc_codes <- read.csv('ARC_List_Full_Extracted.csv')

arc_codes <- arc_codes %>%
  select(Code, Description)


# names(naics_codes)
# naics_codes <- read.csv("naics.csv")
naics_codes <- naics_codes %>%
  select("2022 NAICS US   Code", "2022 NAICS US Title")
names(naics_codes)[names(naics_codes) == "2022 NAICS US   Code"] <- 'NAICS'
names(naics_codes)[names(naics_codes) == "2022 NAICS US Title"] <- 'US_TITLE'
naics_codes$NAICS <- as.numeric(naics_codes$NAICS)
head(naics_codes)
# Initialize a list to hold all data frames
data_frames <- list()

# Loop through each sheet name and read the sheet into a data frame
for (sheet_name in sheet_names) {
  data_frames[[sheet_name]] <- read_excel(file_path, sheet = sheet_name, guess_max = 10000)
}
head(data_frames)

```

# Abstract

# Introduction

The Industrial Assessment Centers (IAC) program plays a crucial role in helping small and medium-sized manufacturers in the United States enhance their energy efficiency, productivity, and waste reduction efforts. This dataset, sourced from the IAC, offers a comprehensive overview of various assessments, recommendations, and implementations aimed at achieving these goals. In light of the global emphasis on sustainability and efficient resource utilization, analyzing this dataset is both timely and significant. By examining the IAC data, we can uncover patterns and insights that may lead to improved practices in energy management and sustainability within the manufacturing sector.

Existing literature and media highlight the importance of energy efficiency and waste reduction as key components of sustainable manufacturing. The IAC program, funded by the Department of Energy, has been instrumental in providing no-cost technical assessments to small and medium-sized enterprises (SMEs) across the U.S. Studies have shown that the recommendations from IAC assessments result in substantial energy savings and cost reductions for participating manufacturers. Additionally, there is a growing trend toward adopting advanced technologies and practices to enhance efficiency and reduce environmental impact in manufacturing.

Our analysis of the IAC dataset aims to answer several key questions that can provide valuable insights into the program's effectiveness and the broader implications for sustainable manufacturing. Firstly, we seek to identify the most common recommendations provided by IAC assessments and how they vary across different industries. Secondly, we aim to quantify the average cost savings and energy savings achieved per assessment, examining how these metrics vary by industry and region. Thirdly, we will explore the adoption rates of IAC recommendations over time and the factors influencing these rates. Lastly, we will assess the long-term impacts of IAC recommendations on the operational efficiency and sustainability of participating manufacturers.

This analysis is significant for several reasons. It can inform policymakers and stakeholders about the effectiveness of the IAC program and help shape future energy efficiency initiatives. Manufacturers can benefit from understanding which recommendations have been most effective in similar contexts, aiding in the adoption of best practices. Furthermore, this study contributes to broader efforts to reduce the environmental impact of manufacturing industries, aligning with global sustainability goals. By identifying cost-saving measures, this research can also help manufacturers reduce operational costs, thereby improving their competitiveness and financial health. Ultimately, this analysis will provide valuable insights into the IAC program's impact, guiding future improvements and fostering a more sustainable manufacturing sector.

# Data

### Explanation of the Data

The datasets utilized for this project comes from the Industrial Assessment Centers (IAC) program. These datasets include detailed information on the assessments conducted, the recommendations given, and the implementations of those recommendations. It serves as a rich source of information, allowing for an in-depth analysis of energy efficiency practices and their outcomes in the manufacturing sector.

We chose these datasets because they offers valuable insights into the effectiveness of the IAC recommendations. By analyzing this data, we can identify common areas for improvement in manufacturing processes, quantify the financial and energy savings achieved, and inform future energy efficiency initiatives. This analysis is particularly relevant given the increasing emphasis on sustainability and efficient resource utilization in manufacturing.

The data is freely available to the public and can be accessed through the IAC's official website: [IAC Database](https://iac.university/). There are no restrictions on the use of this data, making it accessible for both academic and commercial purposes. The dataset covers various aspects of the IAC assessments, including details about the assessments, the recommendations provided, and the implementation status of those recommendations. The population for this dataset includes small and medium-sized manufacturers across the United States that have received assessments from the IAC program.

While the datasets are comprehensive, they do present some data quality issues. Inconsistent data entry can occur. There might also be missing data for certain assessments or recommendations, and a time lag between when assessments are conducted and when the data is entered into the database, potentially affecting the timeliness of the information. Since the the data has been collected over 30 years, some metrics might have changed within the program and more recent assignments may be more detailed than prior assessments. Despite these issues, the dataset remains a valuable resource for analyzing energy efficiency practices in the manufacturing sector.

The Data comes in 1 .xls file with 6 seperate sheets. The first sheet is a list of anonymous companies with metrics about about their operations and the amount of recommendations that they had. The data can be combined using the `ID` to compare metrics about the companies assessed and the recommendations they receive. Currently no recommendation has company data assoicated with it other than `ID`.

---
title: "Analysis of IAC Energy Assessment Data"
author: "Your Name"
date: "2024-05-15"
output: html_document
---

## Introduction to the Data

This report analyzes datasets provided by the Industrial Assessment Centers (IAC) program. These datasets are instrumental for studying energy efficiency practices and their outcomes in the manufacturing sector.

### Source and Data Availability

- **Collector**: Data collected by the Industrial Assessment Centers (IAC), supported by the Department of Energy.
- **Access**: Data is publicly available and can be accessed here: [IAC Database](https://iac.university/). There are no restrictions on its use, making it available for both academic and commercial purposes.

### Dataset Overview

- **Content**: The dataset includes detailed records from energy assessments across various manufacturing sites:
  - `ASSESS`: General information about each assessment.
  - `RECC1 to RECC6`: Specific energy-saving recommendations.
  - `Terms`: Definitions and terminologies used within the dataset.
- **Population and Sample**:
  - **Population**: Small and medium-sized manufacturing facilities in the U.S.
  - **Sample**: Each record represents an individual assessment conducted by the IAC.

## Data Explanation and Description

### Data Structure and Quality

**Dimensions and Structure**:
- **Total Sheets**: `r length(sheet_names)`, including details and recommendations.
- **General Dimensions**:
  - ASSESS sheet: `r nrow(data_frames[['ASSESS']])` rows x `r ncol(data_frames[['ASSESS']])` columns
  - RECC sheets: Each approximately `r nrow(data_frames[['RECC1']])` rows x `r ncol(data_frames[['RECC1']])` columns

**Variables and Coding**:
- **Key Variables**: Include identifiers, dates, types of recommendations, potential and actual savings, implementation status.
- **Coding**: Numerically and categorically coded variables.
- **Column names**: 

 The Column for ACCESS can be seen below
```{r}

for (i in 1:nrow(data_frames[['Terms']])){
  cat(data_frames[['Terms']][['ASSESS Terms']][i],": ", data_frames[['Terms']][[2]][i], '\n')
}

```

 The Column for RECC can be seen below
```{r}

for (i in 1:nrow(data_frames[['Terms']])) {
  term <- data_frames[['Terms']][['RECC Terms']][i]
  description <- data_frames[['Terms']][[5]][i]
  if (!is.na(term) && !is.na(description)) {
    cat(term, ": ", description, '\n')
  }
}

```
                   
**Data Quality Issues**:
- **Missing Data**: Notable in implementation status and metrics.
- **Inconsistencies and Anomalies**: Variability in entries and some columns with mixed data types.

### Handling Data Quality Issues

To ensure the integrity of our analysis:
- **Consistency Checks**: Scripts to verify data consistency.
- **Missing Data Handling**: Strategies like imputation or exclusion based on the scenario.
- **Data Conversion**: Convert mixed-type columns to text, then to numeric post-cleanup.



# Methods

# Graphs and Setup
## Setting up Dataframe
```{r}
all_reccs <- tibble()
for(sheet_name in sheet_names[2:7]){
  print(sheet_name)
  all_reccs <- bind_rows(all_reccs, data_frames[[sheet_name]])
}
nrow(all_reccs)
print(sheet_names)

```

## Joining the Data
```{r}
joined_frames <- left_join(data_frames[["ASSESS"]], naics_codes, "NAICS")
all_reccs <- left_join(all_reccs, arc_codes, c("ARC2"= "Code"))
joined_frames <- left_join(joined_frames, all_reccs, "ID")

joined_frames <- joined_frames %>% 
  mutate(STATE = toupper(STATE)) %>% 
  select(!FY.y)

# unique(joined_frames$STATE)

joined_frames$STATE <- toupper(joined_frames$STATE)
names(joined_frames)[names(joined_frames) == 'FY.x'] <- 'FY'
# joined_frames <- left_join(joined_frames, arc_codes, c("ARC2"= "Code"))
head(joined_frames)

#joined_frames <- inner_join(data_frames[["ASSESS"]], all_reccs, "ID")
# joined_frames <- joined_frames %>% 
#   mutate(STATE = toupper(STATE)) %>% 
#   select(!FY.y)
# names(joined_frames)[names(joined_frames) == 'FY.x'] <- 'FY'
# joined_frames <- left_join(joined_frames, naics_codes, "NAICS")
# joined_frames <- left_join(joined_frames, arc_codes, c("ARC2"= "Code"))
# tail(joined_frames)

```


## Number of Assessments by State
```{r}

state_lookup <- data.frame(
  abbrev = state.abb,
  full_name = state.name
)

# Ensure the names are in lowercase for consistent matching
state_lookup$abbrev <- tolower(state_lookup$abbrev)
state_lookup$full_name <- tolower(state_lookup$full_name)

state_summary <- joined_frames %>%
  group_by(STATE) %>%
  summarise(assessments = n(), .groups = 'drop')  # Count of assessments


state_summary <- state_summary %>%
  mutate(region = tolower(STATE)) %>%
  left_join(state_lookup, by = c("region" = "abbrev")) %>%
  mutate(region = ifelse(is.na(full_name), region, full_name)) %>%
  select(-full_name, -STATE)  # Clean up unnecessary columns

# Get state map data
states_map <- map_data("state")
states_map$region <- tolower(states_map$region)

# Merge the summarized data with the map data
map_data <- merge(states_map, state_summary, by = "region", all.x = TRUE)

# Create the choropleth map
choropleth_map <- ggplot(map_data, aes(long, lat, group = group, fill = assessments)) +
  geom_polygon(color = "white") +
  scale_fill_gradient(low = "white", high = "blue", na.value = "grey") +
  coord_fixed(1.3) +
  labs(fill = "Number of Assessments") +
  ggtitle("Number of Assessments by State") +
  theme_minimal()

print(choropleth_map)

```



## Energy Costs by Center Across the USA

```{r}
# Bar Plot of Total Energy Costs by Plant
# Calculate total energy costs for each center
energy_cost_columns <- c("EC_plant_cost", "E2_plant_cost", "E3_plant_cost", "E4_plant_cost", "E5_plant_cost", 
                         "E6_plant_cost", "E7_plant_cost", "E8_plant_cost", "E9_plant_cost", "E10_plant_cost", 
                         "E11_plant_cost", "E12_plant_cost")
joined_frames %>% 
  filter(is.na(PSAVED)) %>% 
  nrow()

total_saving <- data_frames[["ASSESS"]] %>%
  filter(!is.na(STATE)) %>% 
  group_by(ID) %>%
  mutate(total_saving = sum(EC_plant_cost, E2_plant_cost, E3_plant_cost, E4_plant_cost, E5_plant_cost, 
                         E6_plant_cost, E7_plant_cost, E8_plant_cost, E9_plant_cost, E10_plant_cost, 
                         E11_plant_cost, E12_plant_cost, na.rm = TRUE))


total_saving <-  total_saving %>%
  group_by(STATE) %>%
  summarize(TOTALPSAVED = mean(total_saving))

  
total_saving %>% 
  ggplot(aes(x = STATE, y = TOTALPSAVED, fill = STATE == "WA")) +
  geom_bar(stat = "identity", linewidth = 1, position = position_dodge2()) +
  labs(title = "Average Energy Cost by State",
       x = "State",
       y = "Average Energy Cost", 
       fill = "Washington") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 90, hjust = 1, size = 5)) +
  theme(legend.position = "none") +
  scale_y_continuous(labels = label_dollar())
  
# +
#   scale_fill_gradient(low = "purple", high = "gold", na.value = "grey")
```

```{r}
# NEed to tinker, only considers primary resource
total_saving_WA <- joined_frames %>%
  filter(STATE == "WA") %>% 
  select(CENTER, PSAVED) %>%
  group_by(CENTER) %>%
  summarize(TOTALPSAVED = mean(PSAVED, na.rm = TRUE)) %>%
  filter(TOTALPSAVED > 0)

total_saving_WA %>% 
  ggplot(aes(x = CENTER, y = TOTALPSAVED)) +
  geom_bar(stat = "identity", fill = "skyblue") +
  labs(title = "Average Energy Costs by Centers in Washington",
       x = "Center",
       y = "Total Energy Cost") +
  theme_minimal() +
  theme(axis.text.x = element_text(angle = 45, hjust = 1)) +
  scale_y_continuous(labels = label_dollar()) 
  
```
<!-- # ```{r} -->
<!-- # # Using only the asessments found in washington -->
<!-- # joined_frames %>%  -->
<!-- #   filter(STATE == "WA") %>% -->
<!-- #   select(CENTER, PSOURCCODE) %>%  -->
<!-- #   group_by(CENTER) %>%  -->
<!-- #   #count(PSOURCCODE, na.rm = TRUE) %>%  -->
<!-- #   # Need a little help on this one, need the amounts on the side -->
<!-- #   ggplot(aes(x = factor(CENTER), y = PSOURCCODE, fill = PSOURCCODE)) + -->
<!-- #   geom_bar(stat = "identity", , position = position_dodge()) + -->
<!-- #   labs(title = "Washington Centers by Primary Savings", -->
<!-- #        x = "Center", -->
<!-- #        y = "Total PRimary Energy Savings") + -->
<!-- #   #scale_fill_manual(values = c("purple", "gold"), scale = PSOURCCODE) -->
<!-- #   theme_minimal() + -->
<!-- #   theme(axis.text.x = element_text(angle = 45, hjust = 1)) -->
<!-- #    -->
<!-- # ``` -->

```{r}
# joined_frames %>% 
#   filter(STATE == "WA") %>% 
#   group_by(CENTER) %>% 
#   count(PSOURCCODE, na.rm = TRUE) %>% 
#   filter(n > 25) %>% 
#   ggplot(aes(x = CENTER, y = n, fill = PSOURCCODE)) +
#   geom_bar(stat = "identity", , position = position_dodge()) +
#   labs(title = "Washington Centers by Primary Resource",
#        x = "Center",
#        y = "Count of Reports for Energy of that Type",
#        )
#   #scale_fill_manual(values = c("purple", "gold"), scale = PSOURCCODE)
#   # theme_minimal() +
#   # theme(axis.text.x = element_text(angle = 45, hjust = 1))
#   # select(CENTER, PSOURCCODE) %>% 
#   # summarize(code_count = count(PSOURCCODE, na.rm = TRUE))
```

```{r}
# Highest count NAICS code, grouped by Center
joined_frames %>% 
  filter(STATE == "WA") %>% 
  select(CENTER, NAICS, STATE, US_TITLE) %>% 
  group_by(CENTER) %>%
  na.omit() %>%
  count(US_TITLE, na.rm = TRUE) %>%
  filter(rank(desc(n)) < 5) %>%
  # Change the fill name to the actual product
  ggplot(aes(x = CENTER, y = n, fill = factor(US_TITLE))) +
  geom_bar(stat = "identity", position = position_dodge()) +
  labs(title = "Most Assessed Industries by Centers in Washington",
       x = "Center",
       y = "Report Count",
       fill = "Industry"
       )
```



```{r}
# Tracking Savings per fiscal year
joined_frames %>% 
  filter(STATE == "WA") %>% 
  select(SUPERID, ID, NAICS, CENTER, SALES, FY) %>% 
  filter(!is.na(SALES)) %>% 
  group_by(CENTER, FY) %>%
  summarize(SALES_TOTAL = sum(SALES)) %>%
  ggplot(aes(x = FY, y = SALES_TOTAL, fill = CENTER)) +
  geom_bar(stat = "identity", size = 2) +
  ggtitle("Total Yearly Sales by Companies \nAssessed by Washington Based Centers") +
  labs(x = "Fiscal Year",
       y = "Total Yearly Sales",
       fill = "Assesment Center"
       ) +
  scale_y_continuous(labels = label_dollar()) +
  theme(text = element_text(size=15))
```
```{r}
joined_frames %>% 
  filter(STATE == "WA") %>% 
  select(SUPERID, ID, NAICS, CENTER, FY, PSAVED, SSAVED, TSAVED, QSAVED) %>% 
  group_by(CENTER, FY) %>% 
  mutate(TOTAL_SAVED = sum(PSAVED, SSAVED, TSAVED, QSAVED, na.rm = TRUE)) %>%
  ggplot(aes(x = FY, y = TOTAL_SAVED, fill = CENTER)) +
  geom_bar(stat = "identity", size = 2) +
  labs(title = "Total Costs Savings from Reccomendations for \nCompanies Assessed by Washington Based Centers",
       x = "Fiscal Year",
       y = "Total Yearly Savings Over All Resources",
       fill = "Assesment Center"
       ) +
  scale_y_continuous(labels = label_dollar()) +
  theme(text = element_text(size=15))
```
## Earning back a percentage of their revenue in Savings
```{r}
joined_frames %>% 
  filter(STATE == "WA") %>% 
  select(CENTER, FY, PSAVED, SSAVED, TSAVED, QSAVED, SALES) %>% 
  group_by(CENTER, FY) %>% 
  mutate(TOTAL_SAVED = sum(PSAVED, SSAVED, TSAVED, QSAVED, na.rm = TRUE)) %>%
  mutate(SALES_TOTAL = sum(SALES, na.rm = TRUE)) %>%
  mutate(SAVED_TO_SALES = TOTAL_SAVED/SALES_TOTAL) %>% 
  ggplot(aes(x = FY, y = SAVED_TO_SALES, fill = CENTER)) +
  geom_bar(stat = "identity", size = 2) +
  labs(title = "Savings as Percentage of Sales",
       x = "Fiscal Year",
       y = "Total Yearly Savings Over All Resources",
       fill = "Assesment Center"
       ) +
  #scale_y_continuous(labels = label_dollar()) +
  theme(text = element_text(size=15))
```


```{r}

# Identifying top 5 industries by number of entries
Top5groups <- joined_frames %>%
  filter(!is.na(US_TITLE), !is.na(NAICS)) %>%
  count(US_TITLE) %>%
  arrange(desc(n)) %>%
  slice_head(n = 5)

# Prepare data for graphing, including only top five recommendations per industry
graphed <- joined_frames %>%
  select(US_TITLE, ARC2, PSAVED, SSAVED, TSAVED, QSAVED, Description) %>%
  filter(US_TITLE %in% Top5groups$US_TITLE) %>%
  mutate(TOTAL_SAVED = PSAVED + SSAVED + TSAVED + QSAVED) %>%
  group_by(US_TITLE, ARC2, Description) %>%
  summarize(TOTAL_SAVED = sum(TOTAL_SAVED, na.rm = TRUE), .groups = 'drop') %>%
  arrange(US_TITLE, desc(TOTAL_SAVED)) %>%
  group_by(US_TITLE) %>%
  slice_head(n = 5) %>%
  ungroup() %>%
  mutate(ARC2 = factor(ARC2))  # Factor conversion here for better control

# Create the plot
ggplot(graphed, aes(x = ARC2, y = TOTAL_SAVED, fill = Description)) +
  geom_bar(stat = "identity", position = position_dodge()) +
  facet_wrap(~US_TITLE, scales = "free_x") +
  labs(title = "Top 5 Recommendations by Savings Across Top 5 Industries",
       x = "Recommendation Code", y = "Total Savings", fill = "Recommendation") +
  scale_y_continuous(labels = label_dollar())
  theme(axis.text.x = element_text(angle = 45, hjust = 1), 
        text = element_text(size = 12))  # Adjusting text size 


```


```{r}
# For UW, Savings per year by industry/energy type
# Going to use Primary Energy type, as is mainly the focus
joined_frames %>% 
  filter(CENTER == "UW") %>% 
  select(FY, PSOURCCODE, PSAVED) %>% 
  filter(substr(PSOURCCODE, 1, 1) == "E") %>% 
  group_by(FY, PSOURCCODE) %>% 
  summarize(SAVED_SUM = sum(PSAVED, na.rm = TRUE)) %>% 
  ggplot(aes(x = FY, y = SAVED_SUM, color = factor(PSOURCCODE))) +
  geom_point(stat = "identity", size = 3) +
  labs(title = "Total Saved by Energy Type for the UW Center",
       x = "Fiscal Year",
       y = "Saved Money by Primary Energy Type",
       color = "Primary Source of Energy"
       ) +
  scale_y_continuous(labels = label_dollar()) +
  theme(text = element_text(size=10)) +
  guides(color = guide_legend(ncol = 2))

```
We can see that in general, the category that has the most savings associated with it is EC, which represents Electrical Consumption, or in other words, how much electricity is used by the company in a given year. However, the reason that this category has the highest savings is because the UW center's main focus is on electrical consumption. If we also look at the amount of reccomendations for each energy type, we can see that a majority of reccomendations are aimed at improving savings on Electrical Consumption.

```{r}
# For UW, Savings per year by industry/energy type
# Going to use Primary Energy type, as is mainly the focus
joined_frames %>% 
  filter(CENTER == "UW") %>% 
  select(FY, PSOURCCODE, PSAVED) %>% 
  filter(substr(PSOURCCODE, 1, 1) == "E") %>% 
  group_by(PSOURCCODE) %>%
  summarize(count = n())

```

If we look at the data without Electrical Consumption:

```{r}
# For UW, Savings per year by industry/energy type
# Going to use Primary Energy type, as is mainly the focus
joined_frames %>% 
  filter(CENTER == "UW") %>% 
  select(FY, PSOURCCODE, PSAVED) %>% 
  filter(substr(PSOURCCODE, 1, 1) == "E") %>% 
  filter(PSOURCCODE != "EC") %>% 
  group_by(FY, PSOURCCODE) %>% 
  summarize(SAVED_SUM = sum(PSAVED, na.rm = TRUE)) %>% 
  ggplot(aes(x = FY, y = SAVED_SUM, color = factor(PSOURCCODE))) +
  geom_point(stat = "identity", size = 3) +
  labs(title = "Total Saved by Energy Type for the UW Center",
       x = "Fiscal Year",
       y = "Saved Money by Primary Energy Type",
       color = "Primary Source of Energy"
       ) +
  scale_y_continuous(labels = label_dollar()) +
  theme(text = element_text(size=10)) +
  guides(color = guide_legend(ncol = 2))

```
We can see that the most savings is again, the one with the second most recommendations, which is E2, or Natural Gas Consumption.
# Results

# Discussion

# Summary